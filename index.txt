<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccMaster Pro - Firebase Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Segoe UI', 'Roboto', 'sans-serif'] },
                    animation: {
                        'slide-in': 'slideIn 0.4s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideIn: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        scaleIn: { from: { transform: 'scale(0.9)', opacity: 0 }, to: { transform: 'scale(1)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">

    <div id="root">
        <div class="min-h-screen flex flex-col items-center justify-center space-y-4">
            <div class="loader"></div>
            <p class="text-slate-500 font-medium">Đang kết nối Firebase...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, 
            doc, onSnapshot, query, orderBy, setDoc, getDocs, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG TỪ BẠN CUNG CẤP
        const firebaseConfig = {
            apiKey: "AIzaSyCQFwB4erEE2_Kt5BqQ8NGVVKKNbdnvIzo",
            authDomain: "quan-li-acc.firebaseapp.com",
            projectId: "quan-li-acc",
            storageBucket: "quan-li-acc.firebasestorage.app",
            messagingSenderId: "638625565768",
            appId: "1:638625565768:web:483632f81b1cf07e1fdc7d",
            measurementId: "G-1HZD58196W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Expose Firebase Functions to Window for React
        window.db = db;
        window.fs = { 
            collection, addDoc, updateDoc, deleteDoc, 
            doc, onSnapshot, query, orderBy, setDoc, getDocs, writeBatch 
        };
        
        // Signal Ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>,
                CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>,
                DollarSign: <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>,
                Trash2: <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>,
                TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>,
                Clock: <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>,
                PlayCircle: <circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/>,
                ShoppingBag: <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/>,
                ArrowRight: <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>,
                Copy: <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
                Award: <circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>,
                Layers: <polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>,
                Search: <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>,
                Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>,
                Sun: <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>,
                Edit2: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                X: <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>,
                History: <path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>,
                Shuffle: <polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/>,
                AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>,
                Plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
                Minus: <line x1="5" y1="12" x2="19" y2="12"/>,
                Timer: <line x1="10" y1="2" x2="14" y2="2"/><line x1="12" y1="14" x2="15" y2="11"/><circle cx="12" cy="14" r="8"/>,
                Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
                UserCog: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/><circle cx="12" cy="12" r="3"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/>,
                Briefcase: <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>,
                Percent: <line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/>,
                User: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        const DEFAULT_USERS = [
            { id: 'admin', username: 'Admin', password: '1111', role: 'admin', name: 'Administrator' },
            { id: 'minh', username: 'minh', password: '1234', role: 'viewer', name: 'Minh Sale' },
            { id: 'huy', username: 'huy', password: '1234', role: 'viewer', name: 'Huy Sale' }
        ];

        // --- DATA SERVICE (FIREBASE) ---
        const DataService = {
            colUsers: () => window.fs.collection(window.db, 'users'),
            colAccounts: () => window.fs.collection(window.db, 'accounts'),
            colHistory: () => window.fs.collection(window.db, 'history'),
            
            async seedUsersIfEmpty() {
                const snap = await window.fs.getDocs(this.colUsers());
                if (snap.empty) {
                    const batch = window.fs.writeBatch(window.db);
                    DEFAULT_USERS.forEach(u => {
                        const ref = window.fs.doc(this.colUsers(), u.id);
                        batch.set(ref, u);
                    });
                    await batch.commit();
                    console.log("Seeded Default Users");
                }
            }
        };

        // --- APP ---
        const App = () => {
            const [isReady, setIsReady] = useState(false);
            const [isDark, setIsDark] = useState(true);
            const [appName] = useState("AccMaster Pro");
            
            // Auth State
            const [currentUser, setCurrentUser] = useState(null); 
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');

            // Live Data
            const [users, setUsers] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [history, setHistory] = useState([]);

            // Local UI State
            const [generatedCreds, setGeneratedCreds] = useState({ email: '', password: '' });
            const [formData, setFormData] = useState({ username: '', password: '', price: '', note: '' });
            const [filter, setFilter] = useState('all'); 
            const [toast, setToast] = useState(null);
            const [now, setNow] = useState(Date.now());
            const [sellQuantity, setSellQuantity] = useState(1);
            const [selectedSellerId, setSelectedSellerId] = useState('admin');

            // Modals
            const [showHistory, setShowHistory] = useState(false);
            const [showUserManage, setShowUserManage] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [confirmModal, setConfirmModal] = useState(null); 
            const [soldModal, setSoldModal] = useState(null);
            const [editingUser, setEditingUser] = useState(null);
            const [profileForm, setProfileForm] = useState({ username: '', password: '', name: '' });

            // --- INITIALIZATION ---
            useEffect(() => {
                const init = async () => {
                    if (window.db) {
                        await DataService.seedUsersIfEmpty();
                        
                        // Subscribe to collections
                        const unsubUsers = window.fs.onSnapshot(DataService.colUsers(), (snap) => {
                            setUsers(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });
                        const unsubAccs = window.fs.onSnapshot(window.fs.query(DataService.colAccounts(), window.fs.orderBy('createdAt', 'desc')), (snap) => {
                            setAccounts(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });
                        const unsubHist = window.fs.onSnapshot(window.fs.query(DataService.colHistory(), window.fs.orderBy('soldAt', 'desc')), (snap) => {
                            setHistory(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });

                        setIsReady(true);
                        return () => { unsubUsers(); unsubAccs(); unsubHist(); };
                    }
                };
                
                if (window.db) init();
                else window.addEventListener('firebase-ready', init);
            }, []);

            // --- TIMER LOGIC ---
            useEffect(() => {
                const interval = setInterval(() => {
                    setNow(Date.now());
                }, 60000); 
                return () => clearInterval(interval);
            }, []);

            // --- AUTH LOGIC ---
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => 
                    u.username.toLowerCase() === loginForm.username.toLowerCase() && 
                    u.password === loginForm.password
                );

                if (user) {
                    setCurrentUser(user);
                    setLoginError('');
                    showToast(`Xin chào ${user.name}!`, 'success');
                    setSelectedSellerId(user.role === 'admin' ? 'admin' : user.id);
                } else {
                    setLoginError('Sai tên đăng nhập hoặc mật khẩu!');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setLoginForm({ username: '', password: '' });
                setShowHistory(false);
                setShowUserManage(false);
                setShowProfile(false);
            };

            const updateUser = async (id, field, value) => {
                try {
                    await window.fs.updateDoc(window.fs.doc(DataService.colUsers(), id), { [field]: value });
                    if (currentUser && currentUser.id === id) {
                        setCurrentUser(prev => ({...prev, [field]: value}));
                    }
                    showToast('Cập nhật thành công', 'success');
                } catch(e) { console.error(e); showToast('Lỗi cập nhật', 'error'); }
            };
            
            const handleSaveProfile = async () => {
                if (!profileForm.username || !profileForm.password) return showToast('Không được để trống!', 'error');
                await updateUser(currentUser.id, 'username', profileForm.username);
                await updateUser(currentUser.id, 'password', profileForm.password);
                await updateUser(currentUser.id, 'name', profileForm.name);
                setShowProfile(false);
            };

            // --- UTILS ---
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };

            const copyToClipboard = (text, label) => {
                navigator.clipboard.writeText(text).then(() => showToast(`Đã copy ${label}`, 'success'));
            };

            const getCommissionRate = (count) => count >= 22 ? 0.05 : 0.02;

            const getViewerStats = (userId) => {
                const userSales = history.filter(h => h.soldBy === userId);
                const count = userSales.length;
                const totalRevenue = userSales.reduce((sum, item) => sum + item.price, 0);
                const totalCommission = userSales.reduce((sum, item) => sum + (item.commission || 0), 0);
                const currentRate = getCommissionRate(count);
                
                let nextTierText = "Max Level";
                let progress = 100;
                
                if (count < 22) {
                    nextTierText = `Cần ${22 - count} acc để lên 5%`;
                    progress = (count / 22) * 100;
                }
                return { count, totalRevenue, totalCommission, currentRate, nextTierText, progress };
            };

            // --- CORE ACTIONS (FIRESTORE) ---
            const handleAddAccount = async (e) => {
                e.preventDefault();
                if (!formData.username || !formData.password) return;

                const newAccount = {
                    username: formData.username,
                    password: formData.password,
                    price: Number(formData.price) || 0,
                    note: formData.note,
                    daysFarmed: 0,
                    status: 'pending',
                    mode: 'manual',
                    farmingStartedAt: null,
                    soldBy: null,
                    createdAt: Date.now()
                };

                await window.fs.addDoc(DataService.colAccounts(), newAccount);
                setFormData({ username: '', password: '', price: '', note: '' });
                showToast('Đã thêm acc vào Database!');
            };

            const requestDelete = (id) => {
                setConfirmModal({
                    type: 'delete',
                    data: id,
                    title: 'Xác nhận xóa',
                    message: 'Bạn có chắc muốn xóa vĩnh viễn acc này trên Cloud?',
                    onConfirm: async () => {
                        await window.fs.deleteDoc(window.fs.doc(DataService.colAccounts(), id));
                        setConfirmModal(null);
                        showToast('Đã xóa account', 'error');
                    }
                });
            };

            const requestSellSingle = (accId) => {
                const defaultSeller = isAdmin ? 'admin' : currentUser.id;
                setSelectedSellerId(defaultSeller);
                setConfirmModal({
                    type: 'sell_single',
                    data: accId,
                    title: 'Xác nhận bán',
                    message: 'Chọn người bán để tính doanh thu:',
                    isSellConfirm: true,
                    onConfirm: () => performSellSingle(accId)
                });
            };

            const performSellSingle = async (accId) => {
                const accToSell = accounts.find(a => a.id === accId);
                if (!accToSell) return;

                const finalSellerId = isAdmin ? selectedSellerId : currentUser.id;
                const sellerHistoryCount = history.filter(h => h.soldBy === finalSellerId).length;
                const sellerUser = users.find(u => u.id === finalSellerId);
                const isViewer = sellerUser?.role === 'viewer';
                
                let commission = 0;
                if (isViewer) {
                    commission = accToSell.price * getCommissionRate(sellerHistoryCount);
                }

                let finalDays = accToSell.daysFarmed;
                if (accToSell.mode === 'auto' && accToSell.farmingStartedAt) {
                    finalDays = Math.floor((Date.now() - accToSell.farmingStartedAt) / (1000 * 60 * 60 * 24));
                }

                // Batch Write for Atomicity
                const batch = window.fs.writeBatch(window.db);
                
                // 1. Update Account
                const accRef = window.fs.doc(DataService.colAccounts(), accId);
                batch.update(accRef, { status: 'sold', soldBy: finalSellerId });

                // 2. Add History
                const histRef = window.fs.doc(DataService.colHistory()); // Auto ID
                batch.set(histRef, {
                    ...accToSell,
                    daysFarmed: Math.min(50, finalDays), // EDITED: 23 -> 50
                    soldAt: Date.now(),
                    soldMethod: 'manual',
                    soldBy: finalSellerId,
                    commission: commission,
                    originalAccId: accId
                });

                await batch.commit();
                
                setConfirmModal(null);
                setSoldModal({ 
                    type: 'single', username: accToSell.username, password: accToSell.password, 
                    price: accToSell.price, seller: sellerUser?.name 
                });
                showToast(`Đã bán acc!`, 'success');
            };

            const requestSellRandom = () => {
                const getDays = (acc) => acc.mode === 'auto' && acc.farmingStartedAt 
                    ? Math.floor((Date.now() - acc.farmingStartedAt) / (1000 * 60 * 60 * 24)) 
                    : acc.daysFarmed;
                
                // EDITED: 23 -> 50
                const readyAccs = accounts.filter(a => (a.status === 'completed' || (a.status === 'farming' && getDays(a) >= 50)) && a.status !== 'sold');
                
                if (readyAccs.length === 0) return showToast('Không có acc đủ ngày (50 ngày)!', 'error');

                const maxSell = Math.min(sellQuantity, readyAccs.length);
                setSelectedSellerId('admin');
                setConfirmModal({
                    type: 'sell_random',
                    data: readyAccs,
                    title: `Bán Random ${maxSell} Acc`,
                    message: `Chọn người bán cho lô ${maxSell} account này:`,
                    isSellConfirm: true,
                    onConfirm: () => performSellRandom(readyAccs, maxSell)
                });
            };

            const performSellRandom = async (readyAccs, quantity) => {
                const finalSellerId = isAdmin ? selectedSellerId : currentUser.id;
                const shuffled = [...readyAccs].sort(() => 0.5 - Math.random());
                const selectedAccs = shuffled.slice(0, quantity);
                
                const sellerHistoryCount = history.filter(h => h.soldBy === finalSellerId).length;
                const isViewer = users.find(u => u.id === finalSellerId)?.role === 'viewer';
                
                const batch = window.fs.writeBatch(window.db);
                let totalRevenue = 0;

                selectedAccs.forEach((acc, idx) => {
                    const currentCount = sellerHistoryCount + idx; 
                    const comm = isViewer ? acc.price * getCommissionRate(currentCount) : 0;
                    
                    let finalDays = acc.daysFarmed;
                    if (acc.mode === 'auto' && acc.farmingStartedAt) {
                        finalDays = Math.floor((Date.now() - acc.farmingStartedAt) / (1000 * 60 * 60 * 24));
                    }

                    // Update Acc
                    const accRef = window.fs.doc(DataService.colAccounts(), acc.id);
                    batch.update(accRef, { status: 'sold', soldBy: finalSellerId });

                    // Add History
                    const histRef = window.fs.doc(DataService.colHistory());
                    batch.set(histRef, {
                        ...acc,
                        daysFarmed: Math.min(50, finalDays), // Ensure max 50
                        soldAt: Date.now(),
                        soldMethod: 'random_batch',
                        soldBy: finalSellerId,
                        commission: comm,
                        originalAccId: acc.id
                    });
                    totalRevenue += acc.price;
                });

                await batch.commit();
                setConfirmModal(null);
                setSoldModal({ type: 'batch', count: quantity, revenue: totalRevenue, seller: users.find(u=>u.id === finalSellerId)?.name });
                showToast(`Đã bán ${quantity} acc!`, 'success');
            };

            // --- HELPERS (Account Update) ---
            const toggleAccountMode = async (id) => {
                const acc = accounts.find(a => a.id === id);
                if(!acc) return;
                
                const currentMode = acc.mode || 'manual';
                const newMode = currentMode === 'manual' ? 'auto' : 'manual';
                let updates = { mode: newMode };
                
                if (newMode === 'auto') {
                    const msFromDays = (acc.daysFarmed || 0) * 24 * 60 * 60 * 1000;
                    updates.farmingStartedAt = Date.now() - msFromDays;
                    if (acc.status === 'pending') {
                        updates.status = 'farming';
                        updates.farmingStartedAt = Date.now();
                    }
                } else {
                    if (acc.farmingStartedAt) {
                        const daysElapsed = (Date.now() - acc.farmingStartedAt) / (1000 * 60 * 60 * 24);
                        // EDITED: 23 -> 50
                        updates.daysFarmed = Math.min(50, Math.floor(daysElapsed));
                    }
                }
                await window.fs.updateDoc(window.fs.doc(DataService.colAccounts(), id), updates);
            };

            const updateAccountDaysManual = async (id, newDays) => {
                const acc = accounts.find(a => a.id === id);
                const validDays = Math.max(0, Math.min(50, newDays));
                let newStatus = acc.status;
                if (validDays >= 50) newStatus = 'completed';
                else if (validDays > 0 && acc.status === 'pending') newStatus = 'farming';
                else if (validDays > 0 && acc.status === 'completed') newStatus = 'farming';
                else if (validDays === 0) newStatus = 'pending';
                
                await window.fs.updateDoc(window.fs.doc(DataService.colAccounts(), id), { daysFarmed: validDays, status: newStatus });
            };

            const generateHotmail = () => {
                const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let user = ''; for(let i=0;i<8;i++) user+=chars.charAt(Math.floor(Math.random()*chars.length));
                let pass = ''; const pc='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#';
                for(let i=0;i<10;i++) pass+=pc.charAt(Math.floor(Math.random()*pc.length));
                setGeneratedCreds({ email: `${user}@hotmail.com`, password: pass });
            };
            const fillToForm = () => setFormData(prev => ({ ...prev, username: generatedCreds.email, password: generatedCreds.password }));

            // --- VIEW ---
            const theme = {
                bg: isDark ? 'bg-slate-950' : 'bg-slate-50',
                text: isDark ? 'text-slate-100' : 'text-slate-800',
                textMuted: isDark ? 'text-slate-400' : 'text-slate-500',
                card: isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100',
                cardHover: isDark ? 'hover:border-slate-700' : 'hover:border-slate-200',
                input: isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-50 border-slate-200 text-slate-800',
                modalOverlay: 'bg-black/60 backdrop-blur-sm',
                modalBg: isDark ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-800',
            };
            const isAdmin = currentUser && currentUser.role === 'admin';
            const myStats = currentUser && !isAdmin ? getViewerStats(currentUser.id) : null;
            const getAccStatus = (acc) => {
                if (acc.status === 'sold') return 'sold';
                if (acc.status === 'completed') return 'completed';
                if (acc.mode === 'auto' && acc.farmingStartedAt) {
                    // EDITED: 23 -> 50
                    if ((Date.now() - acc.farmingStartedAt) / 86400000 >= 50) return 'completed';
                }
                return acc.status;
            };
            const filteredAccounts = accounts.filter(acc => filter === 'all' ? true : getAccStatus(acc) === filter);
            const stats = {
                total: accounts.length, unsold: accounts.filter(a => a.status !== 'sold').length,
                sold: accounts.filter(a => a.status === 'sold').length,
                completed: accounts.filter(a => getAccStatus(a) === 'completed').length,
                revenue: history.reduce((sum, h) => sum + h.price, 0)
            };

            if (!isReady) return null; // Let loader handle it

            if (!currentUser) {
                return (
                    <div className={`min-h-screen flex items-center justify-center p-4 font-sans ${theme.bg} ${theme.text}`}>
                        <div className={`w-full max-w-md p-8 rounded-2xl shadow-2xl border animate-scale-in ${theme.card}`}>
                            <div className="flex flex-col items-center mb-6">
                                <div className="bg-indigo-600 p-3 rounded-xl mb-4 shadow-lg shadow-indigo-500/30"><Icon name="Lock" size={32} className="text-white" /></div>
                                <h1 className="text-2xl font-bold">AccMaster Cloud</h1>
                                <p className={theme.textMuted}>Đồng bộ dữ liệu Real-time</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="text-xs font-bold uppercase opacity-70">Username</label><input type="text" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} autoFocus /></div>
                                <div><label className="text-xs font-bold uppercase opacity-70">Password</label><input type="password" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} /></div>
                                {loginError && (<div className="p-3 rounded-lg bg-rose-500/10 text-rose-500 text-sm font-bold flex items-center gap-2"><Icon name="AlertTriangle" size={16} /> {loginError}</div>)}
                                <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg active:scale-95">Đăng Nhập</button>
                            </form>
                            <div className="mt-6 text-center text-xs opacity-50"><p>Admin: Admin / 1111</p><p>Viewer: minh / 1234</p></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 pb-20 ${theme.bg} ${theme.text} ${isDark ? 'dark' : ''}`}>
                    {/* MODALS */}
                    {confirmModal && (
                        <div className={`fixed inset-0 z-[60] flex items-center justify-center p-4 animate-fade-in ${theme.modalOverlay}`}>
                            <div className={`w-full max-w-sm rounded-2xl p-6 shadow-2xl border animate-scale-in ${theme.modalBg}`}>
                                <h3 className="text-xl font-bold mb-2 text-center">{confirmModal.title}</h3>
                                <p className={`mb-4 text-center ${theme.textMuted}`}>{confirmModal.message}</p>
                                
                                {/* Seller Selector for Sales */}
                                {confirmModal.isSellConfirm && (
                                    <div className="mb-6">
                                        <label className="block text-xs font-bold uppercase mb-1 opacity-70">Người bán (để tính doanh thu)</label>
                                        <div className={`flex items-center p-3 rounded-xl border-2 ${isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-slate-50'}`}>
                                            <Icon name="User" size={18} className="mr-2 opacity-50"/>
                                            <select 
                                                value={selectedSellerId} 
                                                onChange={(e) => setSelectedSellerId(e.target.value)}
                                                className="bg-transparent w-full outline-none font-medium"
                                                disabled={!isAdmin} // Only admin can change seller, viewers sell as themselves
                                            >
                                                {users.map(u => (
                                                    <option key={u.id} value={u.id} className="text-black">{u.name} ({u.role})</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setConfirmModal(null)}
                                        className={`flex-1 py-3 rounded-xl font-bold transition-colors ${isDark ? 'bg-slate-800 hover:bg-slate-700' : 'bg-slate-200 hover:bg-slate-300'}`}
                                    >
                                        Hủy
                                    </button>
                                    <button 
                                        onClick={confirmModal.onConfirm}
                                        className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg shadow-indigo-500/30 transition-transform active:scale-95 ${confirmModal.type === 'delete' ? 'bg-rose-500 hover:bg-rose-600' : 'bg-indigo-600 hover:bg-indigo-500'}`}
                                    >
                                        Xác nhận
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SOLD SUCCESS MODAL */}
                    {soldModal && (
                        <div className={`fixed inset-0 z-[60] flex items-center justify-center p-4 animate-fade-in ${theme.modalOverlay}`}>
                            <div className={`w-full max-w-sm rounded-2xl p-6 shadow-2xl border animate-scale-in text-center ${theme.modalBg}`}>
                                <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-green-500/30">
                                    <Icon name="Check" size={32} className="text-white" />
                                </div>
                                <h3 className="text-2xl font-bold mb-2 text-green-500">Giao dịch thành công!</h3>
                                
                                {soldModal.type === 'single' ? (
                                    <div className="space-y-3 mb-6 text-left p-4 rounded-xl bg-slate-500/5 border border-slate-500/10">
                                        <p><span className="opacity-50 text-xs uppercase font-bold">Account:</span> <span className="font-mono font-bold">{soldModal.username}</span></p>
                                        <p><span className="opacity-50 text-xs uppercase font-bold">Password:</span> <span className="font-mono font-bold">{soldModal.password}</span></p>
                                        <p><span className="opacity-50 text-xs uppercase font-bold">Giá bán:</span> <span className="font-bold text-green-500">{soldModal.price.toLocaleString()} đ</span></p>
                                        <p><span className="opacity-50 text-xs uppercase font-bold">Người bán:</span> <span>{soldModal.seller}</span></p>
                                        <button onClick={() => copyToClipboard(`${soldModal.username}|${soldModal.password}`, 'Acc Info')} className="w-full mt-2 flex items-center justify-center gap-2 py-2 rounded-lg bg-indigo-500/10 text-indigo-500 font-bold hover:bg-indigo-500/20"><Icon name="Copy" size={16}/> Copy Info</button>
                                    </div>
                                ) : (
                                    <div className="space-y-2 mb-6">
                                        <p className="text-lg">Đã bán <span className="font-bold">{soldModal.count}</span> account ngẫu nhiên.</p>
                                        <p className="text-xl font-bold text-green-500">+{soldModal.revenue.toLocaleString()} đ</p>
                                        <p className="text-sm opacity-70">Người thực hiện: {soldModal.seller}</p>
                                    </div>
                                )}
                                <button onClick={() => setSoldModal(null)} className="w-full bg-slate-500/20 hover:bg-slate-500/30 font-bold py-3 rounded-xl">Đóng</button>
                            </div>
                        </div>
                    )}

                    {/* HISTORY MODAL */}
                    {showHistory && (
                        <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in ${theme.modalOverlay}`}>
                            <div className={`w-full max-w-4xl max-h-[90vh] flex flex-col rounded-2xl shadow-2xl border animate-scale-in ${theme.modalBg}`}>
                                <div className="p-6 border-b border-slate-500/10 flex justify-between items-center">
                                    <h3 className="text-xl font-bold flex items-center gap-2"><Icon name="History" className="text-indigo-500"/> Lịch sử bán hàng</h3>
                                    <button onClick={() => setShowHistory(false)} className="p-2 hover:bg-slate-500/10 rounded-full"><Icon name="X"/></button>
                                </div>
                                <div className="flex-1 overflow-auto p-6">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="text-xs uppercase opacity-50 border-b border-slate-500/20">
                                                <th className="p-3">Thời gian</th>
                                                <th className="p-3">Account</th>
                                                <th className="p-3">Giá</th>
                                                <th className="p-3">Seller</th>
                                                <th className="p-3">Hoa hồng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {history.map(h => {
                                                const sellerName = users.find(u => u.id === h.soldBy)?.name || 'Unknown';
                                                return (
                                                    <tr key={h.id} className="border-b border-slate-500/5 hover:bg-slate-500/5 transition-colors">
                                                        <td className="p-3 text-sm opacity-70">{new Date(h.soldAt).toLocaleString('vi-VN')}</td>
                                                        <td className="p-3 font-mono text-sm">{h.username}</td>
                                                        <td className="p-3 font-bold text-green-500">{h.price.toLocaleString()}</td>
                                                        <td className="p-3 text-sm">{sellerName}</td>
                                                        <td className="p-3 text-sm">{h.commission ? h.commission.toLocaleString() : '-'}</td>
                                                    </tr>
                                                );
                                            })}
                                            {history.length === 0 && <tr><td colSpan="5" className="p-8 text-center opacity-50">Chưa có lịch sử bán hàng.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* USER PROFILE MODAL */}
                    {showProfile && (
                        <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in ${theme.modalOverlay}`}>
                            <div className={`w-full max-w-md rounded-2xl p-6 shadow-2xl border animate-scale-in ${theme.modalBg}`}>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><Icon name="UserCog" className="text-indigo-500"/> Hồ sơ cá nhân</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase opacity-70">Tên hiển thị</label><input type="text" value={profileForm.name} onChange={e => setProfileForm({...profileForm, name: e.target.value})} className={`w-full px-4 py-2 mt-1 rounded-lg border bg-transparent outline-none focus:border-indigo-500 ${isDark ? 'border-slate-700' : 'border-slate-300'}`} /></div>
                                    <div><label className="text-xs font-bold uppercase opacity-70">Username</label><input type="text" value={profileForm.username} onChange={e => setProfileForm({...profileForm, username: e.target.value})} className={`w-full px-4 py-2 mt-1 rounded-lg border bg-transparent outline-none focus:border-indigo-500 ${isDark ? 'border-slate-700' : 'border-slate-300'}`} /></div>
                                    <div><label className="text-xs font-bold uppercase opacity-70">Password</label><input type="text" value={profileForm.password} onChange={e => setProfileForm({...profileForm, password: e.target.value})} className={`w-full px-4 py-2 mt-1 rounded-lg border bg-transparent outline-none focus:border-indigo-500 ${isDark ? 'border-slate-700' : 'border-slate-300'}`} /></div>
                                    <div className="flex gap-3 mt-4">
                                        <button onClick={() => setShowProfile(false)} className="flex-1 py-2 rounded-lg bg-slate-500/20 hover:bg-slate-500/30 font-bold">Hủy</button>
                                        <button onClick={handleSaveProfile} className="flex-1 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-bold">Lưu thay đổi</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOAST */}
                    {toast && (
                        <div className={`fixed top-4 right-4 z-[70] px-6 py-3 rounded-xl shadow-2xl animate-slide-in flex items-center gap-3 font-bold ${toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-rose-500 text-white'}`}>
                            <Icon name={toast.type === 'success' ? 'CheckCircle' : 'AlertTriangle'} size={24} />
                            {toast.message}
                        </div>
                    )}

                    {/* HEADER */}
                    <header className={`sticky top-0 z-40 px-6 py-4 shadow-sm backdrop-blur-md border-b flex items-center justify-between ${isDark ? 'bg-slate-950/80 border-slate-800' : 'bg-white/80 border-slate-200'}`}>
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg"><Icon name="Layers" className="text-white" size={24} /></div>
                            <div>
                                <h1 className="text-xl font-bold leading-none">{appName}</h1>
                                <p className="text-xs opacity-50 font-medium">Dashboard</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setShowHistory(true)} className={`p-2 rounded-full transition-colors ${theme.cardHover} border border-transparent`} title="Lịch sử"><Icon name="History" /></button>
                            <button onClick={() => setIsDark(!isDark)} className={`p-2 rounded-full transition-colors ${theme.cardHover} border border-transparent`}>{isDark ? <Icon name="Sun" /> : <Icon name="Moon" />}</button>
                            <div className="h-8 w-px bg-slate-500/20 mx-2"></div>
                            <div onClick={() => { setProfileForm({ username: currentUser.username, password: currentUser.password, name: currentUser.name }); setShowProfile(true); }} className="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity">
                                <div className="text-right hidden sm:block">
                                    <p className="text-sm font-bold">{currentUser.name}</p>
                                    <p className="text-xs opacity-50 uppercase">{currentUser.role}</p>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/20">{currentUser.name.charAt(0)}</div>
                            </div>
                            <button onClick={handleLogout} className="p-2 text-rose-500 hover:bg-rose-500/10 rounded-full" title="Đăng xuất"><Icon name="LogOut" /></button>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-8">
                        
                        {/* STATS ROW */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className={`p-5 rounded-2xl border flex items-center gap-4 ${theme.card}`}>
                                <div className="p-3 bg-blue-500/10 text-blue-500 rounded-xl"><Icon name="Briefcase" size={24} /></div>
                                <div><p className="text-xs uppercase font-bold opacity-60">Tổng Acc</p><p className="text-2xl font-bold">{stats.total}</p></div>
                            </div>
                            <div className={`p-5 rounded-2xl border flex items-center gap-4 ${theme.card}`}>
                                <div className="p-3 bg-indigo-500/10 text-indigo-500 rounded-xl"><Icon name="ShoppingBag" size={24} /></div>
                                <div><p className="text-xs uppercase font-bold opacity-60">Chưa bán</p><p className="text-2xl font-bold">{stats.unsold}</p></div>
                            </div>
                            <div className={`p-5 rounded-2xl border flex items-center gap-4 ${theme.card}`}>
                                <div className="p-3 bg-green-500/10 text-green-500 rounded-xl"><Icon name="CheckCircle" size={24} /></div>
                                <div><p className="text-xs uppercase font-bold opacity-60">Đã xong</p><p className="text-2xl font-bold">{stats.completed}</p></div>
                            </div>
                            <div className={`p-5 rounded-2xl border flex items-center gap-4 ${theme.card}`}>
                                <div className="p-3 bg-amber-500/10 text-amber-500 rounded-xl"><Icon name="DollarSign" size={24} /></div>
                                <div><p className="text-xs uppercase font-bold opacity-60">Doanh thu</p><p className="text-2xl font-bold">{stats.revenue.toLocaleString()}</p></div>
                            </div>
                        </div>

                        {/* VIEWER KPI */}
                        {!isAdmin && myStats && (
                            <div className={`p-6 rounded-2xl border relative overflow-hidden ${theme.card}`}>
                                <div className="absolute top-0 right-0 p-32 bg-indigo-500/5 rounded-full blur-3xl pointer-events-none -translate-y-1/2 translate-x-1/2"></div>
                                <div className="flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                                    <div className="flex items-center gap-4">
                                        <div className="w-16 h-16 rounded-full border-4 border-indigo-500 flex items-center justify-center text-xl font-bold bg-indigo-500/10 text-indigo-500">
                                            {Math.round(myStats.currentRate * 100)}%
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold">Cấp độ hoa hồng</h2>
                                            <p className="text-sm opacity-60">{myStats.nextTierText}</p>
                                        </div>
                                    </div>
                                    <div className="flex-1 w-full md:w-auto">
                                        <div className="flex justify-between text-xs font-bold mb-2 uppercase opacity-70"><span>Tiến độ</span><span>{myStats.count}/22 acc</span></div>
                                        <div className="w-full h-3 bg-slate-500/20 rounded-full overflow-hidden">
                                            <div className="h-full bg-indigo-500 transition-all duration-1000 ease-out" style={{ width: `${Math.min(100, myStats.progress)}%` }}></div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xs uppercase font-bold opacity-60">Thu nhập của bạn</p>
                                        <p className="text-2xl font-bold text-green-500">+{myStats.totalCommission.toLocaleString()} đ</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TOOLBAR */}
                        <div className={`p-4 rounded-2xl border flex flex-col lg:flex-row gap-4 justify-between items-center sticky top-20 z-30 shadow-sm ${theme.card}`}>
                            
                            {/* Actions Left */}
                            <div className="flex flex-wrap gap-2 w-full lg:w-auto">
                                {isAdmin && (
                                    <div className="flex items-center gap-2 bg-slate-500/10 p-1 rounded-xl">
                                        <button onClick={generateHotmail} className="px-3 py-2 text-sm font-bold flex items-center gap-2 hover:bg-white/10 rounded-lg transition-colors" title="Tạo mail ảo"><Icon name="Shuffle" size={16} /> Auto Mail</button>
                                        <button onClick={fillToForm} className="px-3 py-2 text-sm font-bold flex items-center gap-2 hover:bg-white/10 rounded-lg transition-colors" title="Điền vào form"><Icon name="ArrowRight" size={16} /></button>
                                    </div>
                                )}
                                <div className={`flex items-center px-3 py-2 rounded-xl border-2 flex-1 lg:flex-none ${theme.input.replace('bg-', '')} ${isDark ? 'border-slate-700' : 'border-slate-200'}`}>
                                    <Icon name="Search" size={18} className="mr-2 opacity-50"/>
                                    <input type="text" placeholder="Tìm kiếm..." className="bg-transparent outline-none w-full text-sm font-medium" />
                                </div>
                            </div>

                            {/* Actions Right */}
                            <div className="flex flex-wrap gap-2 w-full lg:w-auto justify-end">
                                <div className="flex bg-slate-500/10 p-1 rounded-xl">
                                    {['all', 'pending', 'farming', 'completed', 'sold'].map(f => (
                                        <button key={f} onClick={() => setFilter(f)} className={`px-3 py-1.5 rounded-lg text-sm font-bold capitalize transition-all ${filter === f ? 'bg-white text-indigo-600 shadow-sm' : 'hover:bg-white/5 opacity-60 hover:opacity-100'}`}>
                                            {f}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex items-center gap-2 bg-slate-500/10 p-1 rounded-xl">
                                    <button onClick={() => setSellQuantity(q => Math.max(1, q - 1))} className="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded-lg"><Icon name="Minus" size={14}/></button>
                                    <span className="w-8 text-center font-bold text-sm">{sellQuantity}</span>
                                    <button onClick={() => setSellQuantity(q => q + 1)} className="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded-lg"><Icon name="Plus" size={14}/></button>
                                    <button onClick={requestSellRandom} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 ml-1">Bán Random</button>
                                </div>
                            </div>
                        </div>

                        {/* ADD FORM (ADMIN ONLY) */}
                        {isAdmin && (
                            <div className={`p-6 rounded-2xl border ${theme.card}`}>
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="Plus" className="text-indigo-500"/> Thêm tài khoản mới</h3>
                                <form onSubmit={handleAddAccount} className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                    <div className="md:col-span-3">
                                        <input type="text" placeholder="Username / Email" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} />
                                    </div>
                                    <div className="md:col-span-3">
                                        <input type="text" placeholder="Password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} />
                                    </div>
                                    <div className="md:col-span-2">
                                        <input type="number" placeholder="Giá (VNĐ)" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} />
                                    </div>
                                    <div className="md:col-span-3">
                                        <input type="text" placeholder="Ghi chú (Tên game, skin...)" value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} className={`w-full px-4 py-3 rounded-xl outline-none border-2 focus:border-indigo-500 transition-colors ${theme.input}`} />
                                    </div>
                                    <div className="md:col-span-1">
                                        <button type="submit" className="w-full h-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20 transition-transform active:scale-95"><Icon name="Plus" size={24} /></button>
                                    </div>
                                    
                                    {/* Generated Info Preview */}
                                    {generatedCreds.email && (
                                        <div className="md:col-span-12 flex items-center gap-4 text-xs font-mono opacity-60 bg-slate-500/5 p-2 rounded-lg">
                                            <span>Gen: {generatedCreds.email}</span>
                                            <span>|</span>
                                            <span>Pass: {generatedCreds.password}</span>
                                        </div>
                                    )}
                                </form>
                            </div>
                        )}

                        {/* ACCOUNT LIST */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {filteredAccounts.map(acc => {
                                let displayDays = acc.daysFarmed || 0;
                                if (acc.mode === 'auto' && acc.farmingStartedAt) {
                                    const diff = now - acc.farmingStartedAt;
                                    displayDays = Math.floor(diff / (1000 * 60 * 60 * 24));
                                }
                                
                                const isCompleted = displayDays >= 50; // EDITED: 23 -> 50
                                const isSold = acc.status === 'sold';

                                return (
                                    <div key={acc.id} className={`group relative p-5 rounded-2xl border transition-all duration-300 hover:-translate-y-1 hover:shadow-xl ${isSold ? 'opacity-60 grayscale-[0.5]' : ''} ${theme.card} ${theme.cardHover}`}>
                                        
                                        {/* Status Badge */}
                                        <div className="absolute top-4 right-4 flex items-center gap-2">
                                            {isSold && <span className="px-2 py-1 rounded-md bg-slate-500 text-white text-xs font-bold uppercase">Đã bán</span>}
                                            {!isSold && isCompleted && <span className="px-2 py-1 rounded-md bg-green-500 text-white text-xs font-bold uppercase flex items-center gap-1"><Icon name="Check" size={12}/> Xong</span>}
                                            {!isSold && !isCompleted && acc.mode === 'auto' && <span className="px-2 py-1 rounded-md bg-blue-500 text-white text-xs font-bold uppercase flex items-center gap-1"><Icon name="RefreshCw" size={12} className="animate-spin"/> Auto</span>}
                                        </div>

                                        {/* Main Info */}
                                        <div className="mb-4 pr-16">
                                            <div className="flex items-center gap-2 mb-1">
                                                <h4 className="font-bold text-lg truncate font-mono">{acc.username}</h4>
                                                <button onClick={() => copyToClipboard(acc.username, 'Username')} className="opacity-0 group-hover:opacity-50 hover:!opacity-100 transition-opacity"><Icon name="Copy" size={14}/></button>
                                            </div>
                                            <div className="flex items-center gap-2 text-sm opacity-60">
                                                <span className="font-mono">********</span>
                                                <button onClick={() => copyToClipboard(acc.password, 'Password')} className="opacity-0 group-hover:opacity-50 hover:!opacity-100 transition-opacity"><Icon name="Copy" size={14}/></button>
                                            </div>
                                        </div>

                                        {/* Progress Bar */}
                                        {!isSold && (
                                            <div className="mb-4">
                                                <div className="flex justify-between text-xs font-bold mb-1.5 uppercase opacity-70">
                                                    <span>Tiến độ Farm</span>
                                                    <span className={isCompleted ? 'text-green-500' : ''}>{Math.min(50, displayDays)}/50 ngày</span>
                                                </div>
                                                <div className="w-full h-2 bg-slate-500/10 rounded-full overflow-hidden relative">
                                                    <div className={`absolute left-0 top-0 h-full rounded-full transition-all duration-500 ${isCompleted ? 'bg-green-500' : 'bg-indigo-500'}`} style={{ width: `${Math.min(100, (displayDays/50)*100)}%` }}></div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Footer Actions */}
                                        <div className="flex items-center justify-between pt-4 border-t border-slate-500/10 mt-2">
                                            <div className="font-bold text-indigo-500">{acc.price.toLocaleString()} đ</div>
                                            
                                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 duration-300">
                                                {!isSold && isAdmin && (
                                                    <>
                                                        <button onClick={() => toggleAccountMode(acc.id)} className={`p-2 rounded-lg hover:bg-slate-500/10 ${acc.mode === 'auto' ? 'text-blue-500' : 'text-slate-500'}`} title="Bật/Tắt Auto Farm">
                                                            <Icon name="Zap" size={18} fill={acc.mode==='auto'?'currentColor':'none'} />
                                                        </button>
                                                        <button onClick={() => updateAccountDaysManual(acc.id, displayDays + 1)} className="p-2 rounded-lg hover:bg-slate-500/10 text-slate-500" title="+1 ngày">
                                                            <Icon name="Plus" size={18} />
                                                        </button>
                                                        <button onClick={() => requestDelete(acc.id)} className="p-2 rounded-lg hover:bg-rose-500/10 text-rose-500" title="Xóa">
                                                            <Icon name="Trash2" size={18} />
                                                        </button>
                                                    </>
                                                )}
                                                {!isSold && (
                                                    <button onClick={() => requestSellSingle(acc.id)} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg shadow-lg shadow-indigo-500/30 ml-1">Bán</button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {filteredAccounts.length === 0 && (
                            <div className="text-center py-20 opacity-50 flex flex-col items-center">
                                <Icon name="Search" size={48} className="mb-4 opacity-20" />
                                <p>Không tìm thấy tài khoản nào.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
